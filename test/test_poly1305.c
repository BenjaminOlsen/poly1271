#include "../ref/poly1305.h"

#include <stdint.h>
#include <string.h>
#include <stdio.h>
#include <stdlib.h>


#define ASSERT(cond) do { \
    if (!(cond)) { \
        fprintf(stderr, "FAIL: %s at %s:%d\n", #cond, __FILE__, __LINE__); \
        exit(1); \
    } \
} while(0)

static void print_hex(const uint8_t *buf, size_t len) {
    for (size_t i = 0; i < len; ++i) {
        printf("%02x", (unsigned)buf[i]);
    }
}

/* Helper: run a single KAT */
static int expect_tag(const char *name, const uint8_t tag[16], const uint8_t expected[16]) {
    if (memcmp(tag, expected, 16) != 0) {
        printf("[FAIL] %s\n", name);
        printf("  expected: ");
        print_hex(expected, 16);
        printf("\n  got:      ");
        print_hex(tag, 16);
        printf("\n");
        return 1;
    }

    printf("[ OK ] %s\n", name);
    return 0;
}

static void poly1305_rfc8439_2_5_2_kat(void) {

    /* RFC 8439 section 2.5.2  */
    /* Key:
       85:d6:be:78:57:55:6d:33:7f:44:52:fe:42:d5:06:a8:
       01:03:80:8a:fb:0d:b2:fd:4a:bf:f6:af:41:49:f5:1b */
    static const uint8_t K_2_5_2[32] = {
        0x85, 0xd6, 0xbe, 0x78, 0x57, 0x55, 0x6d, 0x33,
        0x7f, 0x44, 0x52, 0xfe, 0x42, 0xd5, 0x06, 0xa8,
        0x01, 0x03, 0x80, 0x8a, 0xfb, 0x0d, 0xb2, 0xfd,
        0x4a, 0xbf, 0xf6, 0xaf, 0x41, 0x49, 0xf5, 0x1b
    };

    /* Message: "Cryptographic Forum Research Group" */
    static const uint8_t M_2_5_2[] = {
        'C','r','y','p','t','o','g','r','a','p','h','i','c',' ',
        'F','o','r','u','m',' ','R','e','s','e','a','r','c','h',' ',
        'G','r','o','u','p'
    };

    /* Tag: a8 06 1d c1 30 51 36 c6 c2 2b 8b af 0c 01 27 a9 */
    static const uint8_t T_2_5_2[16] = {
        0xa8, 0x06, 0x1d, 0xc1,
        0x30, 0x51, 0x36, 0xc6,
        0xc2, 0x2b, 0x8b, 0xaf,
        0x0c, 0x01, 0x27, 0xa9
    };

    uint8_t tag[16];
    poly1305(tag, M_2_5_2, sizeof(M_2_5_2), K_2_5_2);
    expect_tag("RFC8439 2.5.2 KAT", tag, T_2_5_2);
}
 

/* Test Vector #1 */
static const uint8_t K_A3_1[32] = {
    /* one-time key: 32 x 0x00 */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static const uint8_t M_A3_1[64] = {
    /* 4 blocks of 16 zero bytes */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static const uint8_t T_A3_1[16] = {
    /* tag: 16 x 0x00 */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* Test Vector #2 */
static const uint8_t K_A3_2[32] = {
    /* one-time key: r = 0, s = 36 e5 ... 3e */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x36,0xe5,0xf6,0xb5,0xc5,0xe0,0x60,0x70,
    0xf0,0xef,0xca,0x96,0x22,0x7a,0x86,0x3e
};

static const uint8_t M_A3_2[] = {
    0x41,0x6e,0x79,0x20,0x73,0x75,0x62,0x6d,0x69,0x73,0x73,0x69,0x6f,0x6e,0x20,0x74,
    0x6f,0x20,0x74,0x68,0x65,0x20,0x49,0x45,0x54,0x46,0x20,0x69,0x6e,0x74,0x65,0x6e,
    0x64,0x65,0x64,0x20,0x62,0x79,0x20,0x74,0x68,0x65,0x20,0x43,0x6f,0x6e,0x74,0x72,
    0x69,0x62,0x75,0x74,0x6f,0x72,0x20,0x66,0x6f,0x72,0x20,0x70,0x75,0x62,0x6c,0x69,
    0x63,0x61,0x74,0x69,0x6f,0x6e,0x20,0x61,0x73,0x20,0x61,0x6c,0x6c,0x20,0x6f,0x72,
    0x20,0x70,0x61,0x72,0x74,0x20,0x6f,0x66,0x20,0x61,0x6e,0x20,0x49,0x45,0x54,0x46,
    0x20,0x49,0x6e,0x74,0x65,0x72,0x6e,0x65,0x74,0x2d,0x44,0x72,0x61,0x66,0x74,0x20,
    0x6f,0x72,0x20,0x52,0x46,0x43,0x20,0x61,0x6e,0x64,0x20,0x61,0x6e,0x79,0x20,0x73,
    0x74,0x61,0x74,0x65,0x6d,0x65,0x6e,0x74,0x20,0x6d,0x61,0x64,0x65,0x20,0x77,0x69,
    0x74,0x68,0x69,0x6e,0x20,0x74,0x68,0x65,0x20,0x63,0x6f,0x6e,0x74,0x65,0x78,0x74,
    0x20,0x6f,0x66,0x20,0x61,0x6e,0x20,0x49,0x45,0x54,0x46,0x20,0x61,0x63,0x74,0x69,
    0x76,0x69,0x74,0x79,0x20,0x69,0x73,0x20,0x63,0x6f,0x6e,0x73,0x69,0x64,0x65,0x72,
    0x65,0x64,0x20,0x61,0x6e,0x20,0x22,0x49,0x45,0x54,0x46,0x20,0x43,0x6f,0x6e,0x74,
    0x72,0x69,0x62,0x75,0x74,0x69,0x6f,0x6e,0x22,0x2e,0x20,0x53,0x75,0x63,0x68,0x20,
    0x73,0x74,0x61,0x74,0x65,0x6d,0x65,0x6e,0x74,0x73,0x20,0x69,0x6e,0x63,0x6c,0x75,
    0x64,0x65,0x20,0x6f,0x72,0x61,0x6c,0x20,0x73,0x74,0x61,0x74,0x65,0x6d,0x65,0x6e,
    0x74,0x73,0x20,0x69,0x6e,0x20,0x49,0x45,0x54,0x46,0x20,0x73,0x65,0x73,0x73,0x69,
    0x6f,0x6e,0x73,0x2c,0x20,0x61,0x73,0x20,0x77,0x65,0x6c,0x6c,0x20,0x61,0x73,0x20,
    0x77,0x72,0x69,0x74,0x74,0x65,0x6e,0x20,0x61,0x6e,0x64,0x20,0x65,0x6c,0x65,0x63,
    0x74,0x72,0x6f,0x6e,0x69,0x63,0x20,0x63,0x6f,0x6d,0x6d,0x75,0x6e,0x69,0x63,0x61,
    0x74,0x69,0x6f,0x6e,0x73,0x20,0x6d,0x61,0x64,0x65,0x20,0x61,0x74,0x20,0x61,0x6e,
    0x79,0x20,0x74,0x69,0x6d,0x65,0x20,0x6f,0x72,0x20,0x70,0x6c,0x61,0x63,0x65,0x2c,
    0x20,0x77,0x68,0x69,0x63,0x68,0x20,0x61,0x72,0x65,0x20,0x61,0x64,0x64,0x72,0x65,
    0x73,0x73,0x65,0x64,0x20,0x74,0x6f
};

static const uint8_t T_A3_2[16] = {
    0x36,0xe5,0xf6,0xb5,0xc5,0xe0,0x60,0x70,
    0xf0,0xef,0xca,0x96,0x22,0x7a,0x86,0x3e
};

/* Test Vector #3 */
static const uint8_t K_A3_3[32] = {
    /* r = 36 e5 ..., s = 0 */
    0x36,0xe5,0xf6,0xb5,0xc5,0xe0,0x60,0x70,
    0xf0,0xef,0xca,0x96,0x22,0x7a,0x86,0x3e,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* same message as #2 */
static const uint8_t *M_A3_3 = M_A3_2;

static const uint8_t T_A3_3[16] = {
    0xf3,0x47,0x7e,0x7c,0xd9,0x54,0x17,0xaf,
    0x89,0xa6,0xb8,0x79,0x4c,0x31,0x0c,0xf0
};

/* Test Vector #4 */
static const uint8_t K_A3_4[32] = {
    0x1c,0x92,0x40,0xa5,0xeb,0x55,0xd3,0x8a,
    0xf3,0x33,0x88,0x86,0x04,0xf6,0xb5,0xf0,
    0x47,0x39,0x17,0xc1,0x40,0x2b,0x80,0x09,
    0x9d,0xca,0x5c,0xbc,0x20,0x70,0x75,0xc0
};

static const uint8_t M_A3_4[] = {
    0x27,0x54,0x77,0x61,0x73,0x20,0x62,0x72,0x69,0x6c,0x6c,0x69,0x67,0x2c,0x20,0x61,
    0x6e,0x64,0x20,0x74,0x68,0x65,0x20,0x73,0x6c,0x69,0x74,0x68,0x79,0x20,0x74,0x6f,
    0x76,0x65,0x73,0x0a,0x44,0x69,0x64,0x20,0x67,0x79,0x72,0x65,0x20,0x61,0x6e,0x64,
    0x20,0x67,0x69,0x6d,0x62,0x6c,0x65,0x20,0x69,0x6e,0x20,0x74,0x68,0x65,0x20,0x77,
    0x61,0x62,0x65,0x3a,0x0a,0x41,0x6c,0x6c,0x20,0x6d,0x69,0x6d,0x73,0x79,0x20,0x77,
    0x65,0x72,0x65,0x20,0x74,0x68,0x65,0x20,0x62,0x6f,0x72,0x6f,0x67,0x6f,0x76,0x65,
    0x73,0x2c,0x0a,0x41,0x6e,0x64,0x20,0x74,0x68,0x65,0x20,0x6d,0x6f,0x6d,0x65,0x20,
    0x72,0x61,0x74,0x68,0x73,0x20,0x6f,0x75,0x74,0x67,0x72,0x61,0x62,0x65,0x2e
};

static const uint8_t T_A3_4[16] = {
    0x45,0x41,0x66,0x9a,0x7e,0xaa,0xee,0x61,
    0xe7,0x08,0xdc,0x7c,0xbc,0xc5,0xeb,0x62
};

/* Test Vector #5 */
static const uint8_t K_A3_5[32] = {
    0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* R */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  /* S */
};

static const uint8_t M_A3_5[16] = {
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

static const uint8_t T_A3_5[16] = {
    0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* Test Vector #6 */
static const uint8_t K_A3_6[32] = {
    0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* R */
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF  /* S */
};

static const uint8_t M_A3_6[16] = {
    0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static const uint8_t T_A3_6[16] = {
    0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* Test Vector #7 */
static const uint8_t K_A3_7[32] = {
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* R */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  /* S */
};

static const uint8_t M_A3_7[] = {
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static const uint8_t T_A3_7[16] = {
    0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* Test Vector #8 */
static const uint8_t K_A3_8[32] = {
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* R */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  /* S */
};

static const uint8_t M_A3_8[] = {
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFB,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,
    0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01
};

static const uint8_t T_A3_8[16] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* Test Vector #9 */
static const uint8_t K_A3_9[32] = {
    0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* R */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  /* S */
};

static const uint8_t M_A3_9[16] = {
    0xFD,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

static const uint8_t T_A3_9[16] = {
    0xFA,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

/* Test Vector #10 */
static const uint8_t K_A3_10[32] = {
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* R */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  /* S */
};

static const uint8_t M_A3_10[] = {
    0xE3,0x35,0x94,0xD7,0x50,0x5E,0x43,0xB9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x33,0x94,0xD7,0x50,0x5E,0x43,0x79,0xCD,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static const uint8_t T_A3_10[16] = {
    0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x55,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

/* Test Vector #11 */
static const uint8_t K_A3_11[32] = {
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00, /* R */
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00  /* S */
};

static const uint8_t M_A3_11[] = {
    0xE3,0x35,0x94,0xD7,0x50,0x5E,0x43,0xB9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x33,0x94,0xD7,0x50,0x5E,0x43,0x79,0xCD,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static const uint8_t T_A3_11[16] = {
    0x13,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static void poly1305_rfc8439_appendix_a3_kats(void) {
    uint8_t tag[16];

    poly1305(tag, M_A3_1, sizeof M_A3_1, K_A3_1);
    expect_tag("RFC8439 A.3 Test Vector #1", tag, T_A3_1);

    poly1305(tag, M_A3_2, sizeof M_A3_2, K_A3_2);
    expect_tag("RFC8439 A.3 Test Vector #2", tag, T_A3_2);

    poly1305(tag, M_A3_3, sizeof M_A3_2, K_A3_3);
    expect_tag("RFC8439 A.3 Test Vector #3", tag, T_A3_3);

    poly1305(tag, M_A3_4, sizeof M_A3_4, K_A3_4);
    expect_tag("RFC8439 A.3 Test Vector #4", tag, T_A3_4);

    poly1305(tag, M_A3_5, sizeof M_A3_5, K_A3_5);
    expect_tag("RFC8439 A.3 Test Vector #5", tag, T_A3_5);

    poly1305(tag, M_A3_6, sizeof M_A3_6, K_A3_6);
    expect_tag("RFC8439 A.3 Test Vector #6", tag, T_A3_6);

    poly1305(tag, M_A3_7, sizeof M_A3_7, K_A3_7);
    expect_tag("RFC8439 A.3 Test Vector #7", tag, T_A3_7);

    poly1305(tag, M_A3_8, sizeof M_A3_8, K_A3_8);
    expect_tag("RFC8439 A.3 Test Vector #8", tag, T_A3_8);

    poly1305(tag, M_A3_9, sizeof M_A3_9, K_A3_9);
    expect_tag("RFC8439 A.3 Test Vector #9", tag, T_A3_9);

    poly1305(tag, M_A3_10, sizeof M_A3_10, K_A3_10);
    expect_tag("RFC8439 A.3 Test Vector #10", tag, T_A3_10);

    poly1305(tag, M_A3_11, sizeof M_A3_11, K_A3_11);
    expect_tag("RFC8439 A.3 Test Vector #11", tag, T_A3_11);

}

/* ----------------------------------------------------------- */
/* borrowed from poly1305-donna's poly1305_power_on_self_test  */
/* https://github.com/floodyberry/poly1305-donna/blob/master/poly1305-donna.c */
/* example from nacl */
static const unsigned char nacl_key[32] = {
    0xee,0xa6,0xa7,0x25,0x1c,0x1e,0x72,0x91,
    0x6d,0x11,0xc2,0xcb,0x21,0x4d,0x3c,0x25,
    0x25,0x39,0x12,0x1d,0x8e,0x23,0x4e,0x65,
    0x2d,0x65,0x1f,0xa4,0xc8,0xcf,0xf8,0x80,
};

static const unsigned char nacl_msg[131] = {
    0x8e,0x99,0x3b,0x9f,0x48,0x68,0x12,0x73,
    0xc2,0x96,0x50,0xba,0x32,0xfc,0x76,0xce,
    0x48,0x33,0x2e,0xa7,0x16,0x4d,0x96,0xa4,
    0x47,0x6f,0xb8,0xc5,0x31,0xa1,0x18,0x6a,
    0xc0,0xdf,0xc1,0x7c,0x98,0xdc,0xe8,0x7b,
    0x4d,0xa7,0xf0,0x11,0xec,0x48,0xc9,0x72,
    0x71,0xd2,0xc2,0x0f,0x9b,0x92,0x8f,0xe2,
    0x27,0x0d,0x6f,0xb8,0x63,0xd5,0x17,0x38,
    0xb4,0x8e,0xee,0xe3,0x14,0xa7,0xcc,0x8a,
    0xb9,0x32,0x16,0x45,0x48,0xe5,0x26,0xae,
    0x90,0x22,0x43,0x68,0x51,0x7a,0xcf,0xea,
    0xbd,0x6b,0xb3,0x73,0x2b,0xc0,0xe9,0xda,
    0x99,0x83,0x2b,0x61,0xca,0x01,0xb6,0xde,
    0x56,0x24,0x4a,0x9e,0x88,0xd5,0xf9,0xb3,
    0x79,0x73,0xf6,0x22,0xa4,0x3d,0x14,0xa6,
    0x59,0x9b,0x1f,0x65,0x4c,0xb4,0x5a,0x74,
    0xe3,0x55,0xa5
};

static const unsigned char nacl_mac[16] = {
    0xf3,0xff,0xc7,0x70,0x3f,0x94,0x00,0xe5,
    0x2a,0x7d,0xfb,0x4b,0x3d,0x33,0x05,0xd9
};


/* Large message test - exercises multiple 4-block iterations */
static void poly1305_large_message_test(void) {
    /* Key with non-trivial r and s */
    static const uint8_t key[32] = {
        0x85, 0xd6, 0xbe, 0x78, 0x57, 0x55, 0x6d, 0x33,
        0x7f, 0x44, 0x52, 0xfe, 0x42, 0xd5, 0x06, 0xa8,
        0x01, 0x03, 0x80, 0x8a, 0xfb, 0x0d, 0xb2, 0xfd,
        0x4a, 0xbf, 0xf6, 0xaf, 0x41, 0x49, 0xf5, 0x1b
    };

    /* 512-byte message (8 iterations of 4-block loop) */
    uint8_t msg[512];
    for (size_t i = 0; i < 512; i++) {
        msg[i] = (uint8_t)(i & 0xFF);
    }

    /* Compute reference tag using one-shot API */
    uint8_t tag_oneshot[16];
    poly1305(tag_oneshot, msg, sizeof(msg), key);

    /* Verify streaming API produces same result */
    uint8_t tag_stream[16];
    poly1305_ctx_t ctx;
    poly1305_init(&ctx, key);
    poly1305_update(&ctx, msg, sizeof(msg));
    poly1305_finish(&ctx, tag_stream);

    if (memcmp(tag_oneshot, tag_stream, 16) != 0) {
        printf("[FAIL] poly1305_large_message_test: one-shot vs streaming mismatch\n");
        printf("  one-shot: "); print_hex(tag_oneshot, 16); printf("\n");
        printf("  stream:   "); print_hex(tag_stream, 16); printf("\n");
        exit(1);
    }

    /* Verify chunked streaming (various sizes) produces same result */
    uint8_t tag_chunked[16];
    poly1305_init(&ctx, key);
    poly1305_update(&ctx, msg, 64);       /* 1 x 4-block */
    poly1305_update(&ctx, msg + 64, 128); /* 2 x 4-block */
    poly1305_update(&ctx, msg + 192, 64); /* 1 x 4-block */
    poly1305_update(&ctx, msg + 256, 17); /* partial */
    poly1305_update(&ctx, msg + 273, 239);/* remainder */
    poly1305_finish(&ctx, tag_chunked);

    if (memcmp(tag_oneshot, tag_chunked, 16) != 0) {
        printf("[FAIL] poly1305_large_message_test: chunked streaming mismatch\n");
        printf("  one-shot: "); print_hex(tag_oneshot, 16); printf("\n");
        printf("  chunked:  "); print_hex(tag_chunked, 16); printf("\n");
        exit(1);
    }

    /* Expected tag (computed from verified implementation) */
    static const uint8_t expected[16] = {
        0xc9, 0x40, 0x08, 0xd5, 0xcd, 0x26, 0x12, 0x6f,
        0x44, 0xf8, 0x93, 0x21, 0x17, 0x4e, 0xbb, 0x0c
    };

    expect_tag("poly1305_large_message_test (512 bytes, 8x 4-block)", tag_oneshot, expected);
}

static void poly1305_nacl_test(void) {
    uint8_t mac[16];
    size_t i;
	for (i = 0; i < sizeof(mac); i++) mac[i] = 0;
    poly1305_ctx_t ctx;
    poly1305_init(&ctx, nacl_key);
    poly1305_update(&ctx, nacl_msg +   0, 32);
	poly1305_update(&ctx, nacl_msg +  32, 64);
	poly1305_update(&ctx, nacl_msg +  96, 16);
	poly1305_update(&ctx, nacl_msg + 112,  8);
	poly1305_update(&ctx, nacl_msg + 120,  4);
	poly1305_update(&ctx, nacl_msg + 124,  2);
	poly1305_update(&ctx, nacl_msg + 126,  1);
	poly1305_update(&ctx, nacl_msg + 127,  1);
	poly1305_update(&ctx, nacl_msg + 128,  1);
	poly1305_update(&ctx, nacl_msg + 129,  1);
	poly1305_update(&ctx, nacl_msg + 130,  1);
	poly1305_finish(&ctx, mac);

    expect_tag("poly1305_nacl_test", mac, nacl_mac);
}

int main(void) {
    poly1305_rfc8439_2_5_2_kat();
    poly1305_rfc8439_appendix_a3_kats();
    poly1305_nacl_test();
    poly1305_large_message_test();

    return 0;
}
